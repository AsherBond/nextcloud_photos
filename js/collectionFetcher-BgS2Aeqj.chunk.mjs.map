{"version":3,"file":"collectionFetcher-BgS2Aeqj.chunk.mjs","sources":["../src/services/collectionFetcher.ts"],"sourcesContent":["/**\n * SPDX-FileCopyrightText: 2022 Nextcloud GmbH and Nextcloud contributors\n * SPDX-License-Identifier: AGPL-3.0-or-later\n */\n\nimport moment from '@nextcloud/moment'\nimport { translate as t } from '@nextcloud/l10n'\n\nimport logger from './logger.js'\nimport { genFileInfo, type PhotoNode } from '../utils/fileUtils.js'\nimport { davClient } from './DavClient.ts'\nimport type { FileStat, ResponseDataDetailed, StatOptions, WebDAVClient } from 'webdav'\n\nexport type Collection = PhotoNode & {\n\tnbItems: number // The number of item in the collection.\n\tlastPhoto: number // The file id for the cover of the collection.\n\tdate: string // The date of the collection.\n\tcollaborators: object[] // The list of collaborators.\n}\n\nexport type RawCollaborators = ''|{collaborator: object[]|object}\nexport type RawCollection = FileStat & { filename: string, props: { collaborators: RawCollaborators }, dateRange: string }\n\nfunction getCollectionDavRequest(extraProps: string[] = []): string {\n\treturn `<?xml version=\"1.0\"?>\n\t\t\t<d:propfind xmlns:d=\"DAV:\"\n\t\t\t\txmlns:oc=\"http://owncloud.org/ns\"\n\t\t\t\txmlns:nc=\"http://nextcloud.org/ns\"\n\t\t\t\txmlns:ocs=\"http://open-collaboration-services.org/ns\">\n\t\t\t\t<d:prop>\n\t\t\t\t\t<nc:last-photo />\n\t\t\t\t\t<nc:nbItems />\n\t\t\t\t\t${extraProps.join('')}\n\t\t\t\t</d:prop>\n\t\t\t</d:propfind>`\n}\n\nfunction getCollectionFilesDavRequest(extraProps: string[] = []): string {\n\treturn `<?xml version=\"1.0\"?>\n\t\t\t<d:propfind xmlns:d=\"DAV:\"\n\t\t\t\txmlns:oc=\"http://owncloud.org/ns\"\n\t\t\t\txmlns:nc=\"http://nextcloud.org/ns\"\n\t\t\t\txmlns:ocs=\"http://open-collaboration-services.org/ns\">\n\t\t\t\t<d:prop>\n\t\t\t\t\t<d:getcontentlength />\n\t\t\t\t\t<d:getcontenttype />\n\t\t\t\t\t<d:getetag />\n\t\t\t\t\t<d:getlastmodified />\n\t\t\t\t\t<d:resourcetype />\n\t\t\t\t\t<nc:metadata-photos-size />\n\t\t\t\t\t<nc:metadata-photos-original_date_time />\n\t\t\t\t\t<nc:metadata-files-live-photo />\n\t\t\t\t\t<nc:has-preview />\n\t\t\t\t\t<nc:hidden />\n\t\t\t\t\t<oc:favorite />\n\t\t\t\t\t<oc:fileid />\n\t\t\t\t\t<oc:permissions />\n\t\t\t\t\t${extraProps.join('')}\n\t\t\t\t</d:prop>\n\t\t\t</d:propfind>`\n}\n\nexport async function fetchCollection(path: string, options: StatOptions, extraProps: string[] = [], client: WebDAVClient = davClient): Promise<Collection|null> {\n\ttry {\n\t\tconst response = await client.stat(path, {\n\t\t\tdata: getCollectionDavRequest(extraProps),\n\t\t\tdetails: true,\n\t\t\t...options,\n\t\t}) as ResponseDataDetailed<RawCollection>\n\n\t\tlogger.debug('[Collections] Fetched a collection: ', { data: response.data })\n\n\t\treturn formatCollection(response.data)\n\t} catch (error) {\n\t\tif (error instanceof DOMException && error.code === error.ABORT_ERR) {\n\t\t\treturn null\n\t\t}\n\n\t\tthrow error\n\t}\n}\n\nexport async function fetchCollections(path: string, options: StatOptions, extraProps: string[] = [], client: WebDAVClient = davClient): Promise<Collection[]> {\n\ttry {\n\t\tconst response = await client.getDirectoryContents(path, {\n\t\t\tdata: getCollectionDavRequest(extraProps),\n\t\t\tdetails: true,\n\t\t\t...options,\n\t\t}) as ResponseDataDetailed<Array<RawCollection>>\n\n\t\tlogger.debug(`[Collections] Fetched ${response.data.length} collections: `, { data: response.data })\n\n\t\treturn response.data\n\t\t\t.filter(collection => collection.filename !== path)\n\t\t\t.map(formatCollection)\n\t} catch (error) {\n\t\tif (error instanceof DOMException && error.code === error.ABORT_ERR) {\n\t\t\treturn []\n\t\t}\n\n\t\tthrow error\n\t}\n}\n\nfunction formatCollection(rawCollection: RawCollection): Collection {\n\tlet collaborators: object[] = []\n\n\t// Ensure that we have a proper collaborators array.\n\tif (rawCollection.props.collaborators === undefined || rawCollection.props.collaborators === '') {\n\t\tcollaborators = []\n\t} else if (typeof rawCollection.props.collaborators.collaborator === 'object') {\n\t\tif (Array.isArray(rawCollection.props.collaborators.collaborator)) {\n\t\t\tcollaborators = rawCollection.props.collaborators.collaborator\n\t\t} else {\n\t\t\tcollaborators = [rawCollection.props.collaborators.collaborator]\n\t\t}\n\t}\n\n\t// Extract custom props.\n\tconst collection = genFileInfo(rawCollection) as Collection\n\tcollection.collaborators = collaborators\n\n\t// Compute date range label.\n\tconst dateRange = JSON.parse(rawCollection.dateRange?.replace(/&quot;/g, '\"') ?? '{}')\n\tif (dateRange.start === null) {\n\t\tdateRange.start = moment().unix()\n\t\tdateRange.end = moment().unix()\n\t}\n\tconst dateRangeFormatted = {\n\t\tstartDate: moment.unix(dateRange.start).format('MMMM YYYY'),\n\t\tendDate: moment.unix(dateRange.end).format('MMMM YYYY'),\n\t}\n\tif (dateRangeFormatted.startDate === dateRangeFormatted.endDate) {\n\t\tcollection.date = dateRangeFormatted.startDate\n\t} else {\n\t\tcollection.date = t('photos', '{startDate} to {endDate}', dateRangeFormatted)\n\t}\n\n\treturn collection\n}\n\nexport async function fetchCollectionFiles(path: string, options: StatOptions, extraProps: string[] = [], client: WebDAVClient = davClient): Promise<PhotoNode[]> {\n\ttry {\n\t\tconst response = await client.getDirectoryContents(path, {\n\t\t\tdata: getCollectionFilesDavRequest(extraProps),\n\t\t\tdetails: true,\n\t\t\t...options,\n\t\t}) as ResponseDataDetailed<Array<FileStat>>\n\n\t\tconst fetchedFiles = response.data\n\t\t\t.map(file => genFileInfo(file))\n\t\t\t.filter(file => file.fileid)\n\n\t\tlogger.debug(`[Collections] Fetched ${fetchedFiles.length} new files: `, { fetchedFiles })\n\n\t\treturn fetchedFiles\n\t} catch (error) {\n\t\tif (error instanceof DOMException && error.code === error.ABORT_ERR) {\n\t\t\treturn []\n\t\t}\n\n\t\tlogger.error('Error fetching collection files', { error })\n\t\tthrow error\n\t}\n}\n"],"names":["getCollectionDavRequest","extraProps","getCollectionFilesDavRequest","fetchCollection","path","options","client","davClient","response","logger","formatCollection","error","fetchCollections","collection","rawCollection","collaborators","genFileInfo","dateRange","moment","dateRangeFormatted","t","fetchCollectionFiles","fetchedFiles","file"],"mappings":"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"}